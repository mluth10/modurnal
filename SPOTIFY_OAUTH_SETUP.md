# Spotify OAuth Setup Guide

This guide will help you set up Spotify OAuth authentication with Supabase for your Modurnal journal app.

## Prerequisites

- A Supabase project (create one at [supabase.com](https://supabase.com))
- A Spotify Developer account (create one at [developer.spotify.com](https://developer.spotify.com))
- Your Supabase project URL and anon key

## Step 1: Set up Spotify Developer App

1. Go to [Spotify Developer Dashboard](https://developer.spotify.com/dashboard)
2. Click "Create App"
3. Fill in the app details:
   - **App name**: Modurnal
   - **App description**: AI-powered journaling app
   - **Website**: Your website URL (optional)
   - **Redirect URIs**: Add your redirect URI (we'll configure this later)
4. Accept the terms and create the app

## Step 2: Configure Spotify App Settings

1. In your Spotify app dashboard, note down:
   - **Client ID**
   - **Client Secret**

2. Add redirect URIs:
   - **For Expo Go**: The redirect URI will be generated by `makeRedirectUri()` in your app
   - **Supabase Callback**: `https://faqjzgvgufvihffuleek.supabase.co/auth/v1/callback`

3. **Important**: For Expo Go, you need to add the generated redirect URI to your Spotify app. The app will log the generated URI to the console when you try to sign in.

4. **Debugging**: Check the console output for lines like:
   ```
   Generated redirect URI: exp://192.168.1.100:8081/--/auth/callback
   Simple redirect URI: exp://192.168.1.100:8081/--
   ```

5. **Add the logged URI** to your Spotify app's redirect URIs list.

6. Save the changes

## Step 3: Configure Supabase OAuth Settings

1. Go to your Supabase dashboard
2. Navigate to **Authentication** > **Providers**
3. Find **Spotify** in the list and click to configure
4. Enable Spotify provider
5. Add your Spotify credentials:
   - **Client ID**: Your Spotify app client ID
   - **Client Secret**: Your Spotify app client secret
6. **Important**: The redirect URL in Supabase will be overridden by the `redirectTo` parameter in your app code
7. Save the configuration

## Step 4: How Expo Go OAuth Works

For Expo Go, the OAuth flow works like this:

1. **Your app** calls `makeRedirectUri()` to generate the correct redirect URI for Expo Go
2. **Your app** calls `supabase.auth.signInWithOAuth()` with the generated redirect URI
3. **Supabase** generates the OAuth URL with the Expo Go redirect URI
4. **WebBrowser** opens the Spotify authorization page
5. **User** authorizes your app on Spotify
6. **Spotify** redirects to the Expo Go redirect URI
7. **Expo Go** handles the callback and your app receives the session
8. **Session** is created and your app is authenticated

## Step 5: Finding Your Expo Go Redirect URI

1. Start your app: `npm start`
2. Open the app in Expo Go
3. Try to sign in with Spotify
4. Check the console output for the generated redirect URI
5. Add that URI to your Spotify app's redirect URIs list
6. Try signing in again

## Step 6: Troubleshooting Redirect URI Issues

If you're getting "Safari can't connect to the server":

1. **Check the console** for the generated redirect URI
2. **Make sure the URI is added** to your Spotify app's redirect URIs
3. **Try both URI formats** that are logged:
   - `exp://192.168.1.100:8081/--/auth/callback`
   - `exp://192.168.1.100:8081/--`
4. **Restart your app** after adding the redirect URI
5. **Clear browser cache** on your device

## Step 7: Set up Environment Variables

1. Create a `.env` file in your project root (if it doesn't exist)
2. Add your credentials:

```env
EXPO_PUBLIC_SUPABASE_URL=your_supabase_project_url
EXPO_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
EXPO_PUBLIC_OPENAI_API_KEY=your_openai_api_key
```

## Step 8: Configure App Scheme

1. Update your `app.json` to include the custom scheme:

```json
{
  "expo": {
    "scheme": "modurnal",
    "ios": {
      "bundleIdentifier": "com.yourcompany.modurnal"
    },
    "android": {
      "package": "com.yourcompany.modurnal"
    }
  }
}
```

## Step 9: Update Database Schema

1. Go to your Supabase dashboard
2. Navigate to the SQL Editor
3. Run the updated schema from `supabase/schema.sql`

This will:
- Add a `user_id` column to the `journal_entries` table
- Create indexes for better performance
- Set up Row Level Security (RLS) policies
- Create triggers to automatically set user_id on insert

## Step 10: Test the Authentication

1. Start your app: `npm start`
2. Try signing in with Spotify
3. Verify that the OAuth flow works correctly
4. Check that journal entries are user-specific

## Features Included

### Authentication Flow
- **Spotify OAuth**: Secure authentication through Spotify
- **User Profile**: Displays Spotify user information
- **Session Management**: Automatic session handling
- **Sign Out**: Secure sign out with confirmation

### Security Features
- **OAuth 2.0**: Industry-standard authentication
- **Row Level Security (RLS)**: Users can only access their own journal entries
- **Secure Storage**: Authentication tokens stored securely
- **Automatic User Association**: New entries linked to current user

### User Experience
- **Modern UI**: Spotify-themed design with dark mode
- **Loading States**: Proper indicators during authentication
- **Error Handling**: User-friendly error messages
- **Seamless Flow**: Automatic navigation based on auth state

## Troubleshooting

### Common Issues

1. **"OAuth provider not configured"**
   - Check that Spotify provider is enabled in Supabase
   - Verify Client ID and Client Secret are correct
   - Ensure redirect URI matches exactly

2. **"Redirect URI mismatch"**
   - Check that the redirect URI in Spotify app matches Supabase
   - Verify the app scheme is configured correctly
   - Make sure the URI format is exact

3. **"Authentication failed"**
   - Check Spotify app settings
   - Verify scopes are configured correctly
   - Check network connectivity

4. **"Users can see other users' entries"**
   - Ensure RLS is enabled on the `journal_entries` table
   - Verify the RLS policy is correctly configured

### Debugging Tips

1. **Check Supabase Logs**:
   - Go to Supabase dashboard > Logs
   - Look for authentication events

2. **Check Spotify App Settings**:
   - Verify redirect URIs are correct
   - Check that the app is not in development mode if needed

3. **Test OAuth Flow**:
   - Use the Supabase Auth UI playground
   - Test with a simple web app first

## Spotify API Scopes

The app requests these scopes:
- `user-read-email`: To get user's email address
- `user-read-private`: To get user's profile information

You can add more scopes if needed for additional features.

## Production Deployment

### App Store Configuration

1. **iOS**:
   - Add URL scheme to Info.plist
   - Configure Associated Domains if needed

2. **Android**:
   - Add intent filters in AndroidManifest.xml
   - Configure app links

### Environment Variables

Make sure to set different environment variables for:
- Development
- Staging
- Production

## Next Steps

Consider adding these features:
- User profile management
- Spotify playlist integration
- Music mood tracking
- Social sharing
- Advanced analytics

## Support

- [Supabase Documentation](https://supabase.com/docs)
- [Spotify Web API Documentation](https://developer.spotify.com/documentation/web-api)
- [Expo AuthSession Documentation](https://docs.expo.dev/versions/latest/sdk/auth-session/) 